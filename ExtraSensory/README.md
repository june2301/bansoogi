# Galaxy Watch HAR 파이프라인 (standing/sitting/lying)

> **리비전 v1 (2025‑05‑07)** – 첫 번째 통합 실행 결과
>
> • Galaxy Watch 7 (40 mm) 단일 기기로 **서기(standing)**·**앉기(sitting)**·**눕기(lying)** 3가지 정적 자세를 자유 환경에서 인식합니다.
> • 걷기·뛰기·계단·운동·수면 등 동적/특수 활동은 Wear OS Health Services 또는 SensorManager가 필터링하며, 경량 CNN은 **정적 구간** 분류에만 집중합니다.

---

## 목차

1. [프로젝트 개요](#1-프로젝트-개요)
2. [데이터셋 및 라벨 매핑](#2-데이터셋-및-라벨-매핑)
3. [전처리 파이프라인](#3-전처리-파이프라인)
4. [모델 아키텍처 및 하이퍼파라미터](#4-모델-아키텍처-및-하이퍼파라미터)
5. [코드/폴더 구조 및 빠른 시작](#5-코드폴더-구조-및-빠른-시작)
6. [학습 로그\_v1](#6-학습-로그_v1)
7. [워치 배포 참고](#7-워치-배포-참고)
8. [다음 단계](#8-다음-단계)

---

## 1. 프로젝트 개요

| 단계                                   | 설명                                                     | 근거                           |
| -------------------------------------- | -------------------------------------------------------- | ------------------------------ |
| **① 동적·특수 활동 필터링**            | Health Services 이벤트(운동, 수면, 계단, 걷기/뛰기) 수신 | OS 수준 필터링으로 배터리 절약 |
| **② 센서 샘플링 25 Hz**                | 가속도·자이로 연속 스트림 (배치 모드)                    | 50 Hz 대비 배터리 소모 절반    |
| **③ 슬라이딩 윈도우 (5 s, 50 % 중첩)** | 125 샘플 × 3축                                           | F₁ 크로스 검증 최적            |
| **④ Dynamic‑Skip**                     | SMA ≥ 0.30 g 또는 GyroRMS ≥ 0.05 rad/s → 분류 생략       | 추론 호출 70 % 감소            |
| **⑤ 1D-CNN (3-class)**                 | Conv32→Conv64→GAP→Softmax(3)                             | 약 46 K 파라미터, 155 KB fp32  |
| **⑥ 히스테리시스**                     | 연속 2개 윈도우(\~7.5 s) 동일 결과 시 상태 확정          | 노이즈 및 잔여 떨림 억제       |
| **⑦ 저장**                             | 15 분당 270 B → 일일 0.8 MB 미만                         | 저장소 부담 무                 |

---

## 2. 데이터셋 및 라벨 매핑

| 소스             | 설명                                        | 라벨 매핑                                                      |
| ---------------- | ------------------------------------------- | -------------------------------------------------------------- |
| **ExtraSensory** | 60명·최대 7일, `watch_acc` + 자세 라벨 제공 | `label:OR_standing→2`, `label:LYING_DOWN→1`, `label:SITTING→0` |
| **CAPTURE-24**   | 151명·24시간, 손목 시계 + 수면 일지         | `sleep*→1`, `sitting*→0`, **standing 라벨 없음**               |

**클래스 불균형 예시**: sitting 7 864 / lying 22 547 / standing 3 240 → 권장 `class_weight = {0:1.5, 1:0.5, 2:2.0}`

---

## 3. 전처리 파이프라인

| 단계              | 값                                   | 이유                          |
| ----------------- | ------------------------------------ | ----------------------------- |
| 샘플링 주파수     | **25 Hz**                            | 배터리 절감                   |
| 저역통과 필터     | 4극 버터워스, 12 Hz                  | Nyquist 상한의 90 %           |
| 윈도우/스트라이드 | 5 s, 50 % 중첩 (윈\_size = 125)      | 교차 검증 F₁ 최적             |
| Dynamic‑Skip 임계 | SMA 0.30 g / GyroRMS 0.05 rad/s      | 미세 동적 움직임 제거         |
| 단위 변환         | ExS: mg→m/s², CAP: g→m/s²            | 단위 통일                     |
| 라벨 조회         | 윈도우 시작 타임스탬프(초) dict 조회 | ExtraSensory 라벨 분해능 맞춤 |

---

## 4. 모델 아키텍처 및 하이퍼파라미터

```text
Input 125×3 → Conv1D(filters=32, kernel=5) → ReLU
                     → Conv1D(filters=64, kernel=5) → ReLU
                     → GlobalAveragePooling1D
                     → Dense(3, activation='softmax')  # standing/sitting/lying
```

| 항목                | 값                                        |
| ------------------- | ----------------------------------------- |
| 파라미터 수         | **46 112** (≈155 KB fp32)                 |
| Optimizer/Epochs/BS | Adam / 25 / 64                            |
| Train/Val split     | 80 % / 20 % 랜덤 분리                     |
| 모델 내보내기       | `model/sitlie_v1.h5` → `sitlie_v1.tflite` |

---

## 5. 코드/폴더 구조 및 빠른 시작

```
ExtraSensory/
├─ data/
│  ├─ exs_raw/        # ExtraSensory 원본 .dat
│  ├─ cap_raw/        # CAPTURE-24 원본 .csv
│  └─ npz/            # 생성된 windows npz 파일
├─ model/             # 학습된 모델 (.h5, .tflite)
├─ logs/              # TensorBoard 로그 (버전별)
└─ src/
   └─ watch_har_pipeline.py
```

```bash
# 1) NPZ 파일 생성
python src/watch_har_pipeline.py --prepare

# 2) 모델 학습 및 TFLite 변환
python src/watch_har_pipeline.py --train
```

버전 관리: 추후 `--version v2` 옵션 추가 또는 스크립트 수정

---

## 6. 학습 로그\_v1

| 지표           | 최고 에포크              | 값         |
| -------------- | ------------------------ | ---------- |
| **Val 정확도** | 23                       | **0.8209** |
| Val 손실       | 23                       | 0.4377     |
| 학습 시간      | 약 1시간 45분 (CPU-only) |            |

<details>
<summary>에포크별 상세 로그</summary>
```
Epoch 1: loss=0.5394, acc=0.7812 → val_acc=0.7985
…
Epoch 25: loss=0.4393, acc=0.8198 → val_acc=0.8209
```
</details>

---

## 7. 워치 배포 참고

1. **추론 타이밍**: 동적/특수 필터 통과 후 5 s 정적 윈도우를 모델에 입력
2. **결과 매핑**: `argmax` 결과 0→sitting, 1→lying, 2→standing
3. **배터리 예측**: 25 Hz + Dynamic‑Skip → Watch 7 기준 시간당 < 4 mAh 소모

---

## 8. 다음 단계

- **v2: GPU 학습 환경 구축** (CUDA 12.3 + cuDNN 8.9) → 에포크당 <30 초 목표
- **INT8 양자화**로 모델 크기 \~40 KB로 줄이기
- **혼동 행렬 & 클래스 가중치 손실**로 F₁ >= 0.90 달성
- **TensorBoard hparams** 플러그인으로 하이퍼파라미터 실험 관리
- **필드 데이터 수집** 후 사용자별 보정 단계 도입

---

> _Maintainer_: Kee‑Hoon Won | PR/이슈 언제든 환영
